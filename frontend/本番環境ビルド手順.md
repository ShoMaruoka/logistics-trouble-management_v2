# フロントエンド本番環境ビルド手順

## 概要
物流トラブル管理システムv2のフロントエンドを本番環境用にビルドする手順です。

## 前提条件
- Node.js 18.0.0以上がインストールされていること
- npm 8.0.0以上がインストールされていること
- 本番環境のAPI URLが決定していること

## 手順

### 1. 環境変数の設定
```bash
# 本番環境用の環境変数ファイルを作成
cp env.production.example .env.production

# .env.productionファイルを編集して本番環境のAPI URLを設定
# NEXT_PUBLIC_API_URL=https://your-production-api-domain.com
```

### 2. 依存関係のインストール
```bash
# フロントエンドディレクトリに移動
cd frontend

# 依存関係のインストール
npm install
```

### 3. 本番環境用ビルド
```bash
# 本番環境用ビルド（推奨）
npm run build:prod

# または通常のビルド
npm run build
```

### 4. 静的ファイルエクスポート（オプション）
```bash
# 静的ファイルとしてエクスポート（CDN配信用）
npm run export:prod
```

### 5. 本番環境での起動
```bash
# 本番環境での起動
npm run start:prod

# または通常の起動
npm run start
```

## ビルド成果物

### build:prod の場合
- `.next/` ディレクトリにビルド成果物が生成されます
- Next.jsのサーバーサイドレンダリング機能を使用
- 動的ルーティングに対応
- API Routesが利用可能

### export:prod の場合
- `out/` ディレクトリに静的ファイルが生成されます
- 完全な静的サイトとして配信可能
- CDN配信に最適
- サーバーサイド機能は利用不可

## 本番環境での推奨構成

### 1. Next.jsサーバーとして配信（推奨）
```bash
npm run build:prod
npm run start:prod
```
- ポート3000で起動
- リバースプロキシ（Nginx等）で配信
- セッション管理やAPI Routesが利用可能

### 2. 静的ファイルとして配信
```bash
npm run export:prod
```
- `out/` ディレクトリをWebサーバーで配信
- より高速な配信が可能
- サーバーサイド機能は利用不可

## 環境変数の設定

### 本番環境用環境変数（.env.production）
```env
# 本番環境のAPI URL
NEXT_PUBLIC_API_URL=https://your-production-api-domain.com

# Node.js環境
NODE_ENV=production
```

### 重要な注意点
- `NEXT_PUBLIC_` プレフィックスが付いた環境変数のみクライアントサイドで利用可能
- 機密情報は環境変数に含めない
- 本番環境では必ずHTTPSを使用

## パフォーマンス最適化

### ビルド時の最適化
- 自動的なコード分割
- 画像の最適化
- CSS/JSの圧縮
- Tree shakingによる不要コードの削除

### 本番環境での最適化
- gzip圧縮の有効化
- ブラウザキャッシュの設定
- CDNの活用
- 静的ファイルの配信最適化

## セキュリティ設定

### セキュリティヘッダー
本番環境では以下のセキュリティヘッダーが自動的に設定されます：
- `X-Frame-Options: DENY`
- `X-Content-Type-Options: nosniff`
- `Referrer-Policy: origin-when-cross-origin`
- `X-XSS-Protection: 1; mode=block`
- `Strict-Transport-Security: max-age=31536000; includeSubDomains`

### 推奨事項
- HTTPSの強制使用
- セキュリティヘッダーの追加設定
- 定期的な依存関係の更新
- 脆弱性スキャンの実施

## トラブルシューティング

### よくある問題

#### 1. ビルドエラー
```bash
# TypeScriptの型チェック
npm run type-check

# ESLintによるコード品質チェック
npm run lint
```

#### 2. 環境変数が読み込まれない
- `.env.production` ファイルが正しい場所にあるか確認
- 環境変数名に `NEXT_PUBLIC_` プレフィックスが付いているか確認
- ビルド後に環境変数を変更した場合は再ビルドが必要

#### 3. API接続エラー
- `NEXT_PUBLIC_API_URL` が正しく設定されているか確認
- CORS設定が適切に行われているか確認
- ネットワーク接続を確認

## デプロイメント

### IISでの配信
1. `npm run build:prod` でビルド
2. `.next/` ディレクトリをIISの物理パスに配置
3. Node.jsアプリケーションとして設定
4. リバースプロキシでポート3000に転送

### Nginxでの配信
1. `npm run export:prod` で静的ファイル生成
2. `out/` ディレクトリをNginxのドキュメントルートに配置
3. 静的ファイルとして配信

## 監視・ログ

### 推奨監視項目
- アプリケーションの起動状態
- レスポンス時間
- エラー率
- メモリ使用量
- CPU使用率

### ログ設定
- アプリケーションログの出力
- エラーログの監視
- アクセスログの分析

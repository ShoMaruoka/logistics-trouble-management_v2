# 物流トラブル管理システム データベース設計書

## 文書情報

| 項目 | 内容 |
|------|------|
| 文書名 | 物流トラブル管理システム データベース設計書 |
| バージョン | 1.0 |
| 作成日 | 2025年10月3日 |
| 最終更新日 | 2025年10月3日 |
| 作成者 | システム開発チーム |

---

## 目次

1. [概要](#1-概要)
2. [設計方針](#2-設計方針)
3. [テーブル構成](#3-テーブル構成)
4. [ER図](#4-er図)
5. [テーブル詳細仕様](#5-テーブル詳細仕様)
6. [リレーションシップ](#6-リレーションシップ)
7. [インデックス設計](#7-インデックス設計)
8. [初期データ](#8-初期データ)
9. [運用考慮事項](#9-運用考慮事項)

---

## 1. 概要

### 1.1 目的
物流品質トラブル管理システムのSQL Server用データベース設計書です。3段階情報管理システム（1次情報→2次情報→3次情報）に必要なテーブル構成とリレーションシップを定義します。

### 1.2 技術スタック
- **データベース**: Microsoft SQL Server 2022
- **ORM**: Entity Framework Core 8.0
- **設計方針**: 正規化されたリレーショナルデータベース設計

### 1.3 開発環境接続情報
- **サーバー**: 10.194.2.38,1434
- **データベース名**: LTMDB
- **認証**: SQL Server認証
- **ユーザー名**: sa
- **パスワード**: Medicalsv@6087!!

### 1.4 設計原則
- 第3正規形までの正規化
- データ整合性の確保
- パフォーマンスの最適化
- 監査性の確保
- 将来の拡張性

---

## 2. 設計方針

### 2.1 正規化
- **第1正規形**: 原子値の確保
- **第2正規形**: 部分関数従属の除去
- **第3正規形**: 推移関数従属の除去

### 2.2 命名規則
- **テーブル名**: 日本語名（例: `インシデント`）
- **カラム名**: 日本語名（例: `作成日`）
- **外部キー**: `{参照テーブル名}ID`（例: `部門ID`）
- **主キー**: `ID`（IDENTITY(1,1)）

### 2.3 データ型
- **文字列**: `NVARCHAR`（Unicode対応）
- **数値**: `INT`（主キー）、`DECIMAL(18,2)`（数量）
- **日時**: `DATETIME2`（高精度）
- **日付**: `DATE`
- **真偽値**: `BIT`
- **大容量テキスト**: `NVARCHAR(MAX)`

---

## 3. テーブル構成

### 3.1 テーブル一覧

| カテゴリ | テーブル名 | 説明 | レコード数見積 |
|----------|------------|------|----------------|
| **マスタテーブル** | 部門 | 部門マスタ | 10件 |
| | 発生場所 | 発生場所マスタ | 10件 |
| | 倉庫 | 倉庫マスタ | 10件 |
| | 運送会社 | 運送会社マスタ | 10件 |
| | トラブル区分 | トラブル区分マスタ | 5件 |
| | トラブル詳細区分 | トラブル詳細区分マスタ | 10件 |
| | 単位 | 単位マスタ | 10件 |
| **ユーザー管理** | ユーザー | ユーザーマスタ | 100件 |
| | ユーザーロール | ユーザーロール | 200件 |
| **メインデータ** | インシデント | インシデント | 10,000件/年 |
| **監査・ログ** | インシデント監査ログ | インシデント監査ログ | 50,000件/年 |
| | システムログ | システムログ | 100,000件/年 |

**合計: 12テーブル**

### 3.2 テーブル分類

#### 3.2.1 マスタテーブル群（7テーブル）
- 参照データを管理するテーブル群
- 変更頻度が低い
- アプリケーション全体で共通利用

#### 3.2.2 ユーザー管理テーブル（2テーブル）
- ユーザー情報とロール管理
- 認証・認可に使用
- デフォルト倉庫による簡易倉庫管理

#### 3.2.3 メインデータテーブル（1テーブル）
- インシデント情報の本体
- 3段階情報管理の実装

#### 3.2.4 監査・ログテーブル（2テーブル）
- 変更履歴の追跡
- システムログの記録

---

## 4. ER図

```
┌─────────────────────────────────────────────────────────────────┐
│                        ER図 - 物流トラブル管理システム            │
└─────────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    部門     │    │   ユーザー   │    │ ユーザーロール│
│             │    │             │    │             │
│ ID (PK)     │◄───┤ ID (PK)     │───►│ ID (PK)     │
│ コード      │    │ ユーザーID  │    │ ユーザーID(FK)│
│ 名称        │    │ 氏名        │    │ ロール      │
│ 有効フラグ  │    │ メール      │    │ 作成日時    │
│ 作成日時    │    │ 部門ID (FK) │    └─────────────┘
│ 更新日時    │    │ 有効フラグ  │
└─────────────┘    │ 作成日時    │
                   │ 更新日時    │
                   └─────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  発生場所   │    │ 倉庫  │    │  運送会社   │
│             │    │             │    │             │
│ ID (PK)     │    │ ID (PK)     │    │ ID (PK)     │
│ コード      │    │ コード      │    │ コード      │
│ 名称        │    │ 名称        │    │ 名称        │
│ 有効フラグ  │    │ 有効フラグ  │    │ 有効フラグ  │
│ 作成日時    │    │ 作成日時    │    │ 作成日時    │
│ 更新日時    │    │ 更新日時    │    │ 更新日時    │
└─────────────┘    └─────────────┘    └─────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ トラブル区分│    │トラブル詳細区分│    │    単位    │
│             │    │             │    │             │
│ ID (PK)     │◄───┤ ID (PK)     │    │ ID (PK)     │
│ コード      │    │ コード      │    │ コード      │
│ 名称        │    │ 名称        │    │ 名称        │
│ 有効フラグ  │    │ トラブル区分ID│    │ 有効フラグ  │
│ 作成日時    │    │ 有効フラグ  │    │ 作成日時    │
│ 更新日時    │    │ 作成日時    │    │ 更新日時    │
└─────────────┘    │ 更新日時    │    └─────────────┘
                   └─────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        インシデント (メインテーブル)              │
│                                                                 │
│ ID (PK)                    │ インシデント番号                   │
│ 作成日                     │ 部門ID (FK)                       │
│ 作成者ID (FK)              │ 発生日時                          │
│ 発生場所ID (FK)            │ 倉庫ID (FK)                 │
│ 運送会社ID (FK)            │ トラブル区分ID (FK)               │
│ トラブル詳細区分ID (FK)    │ 内容詳細                          │
│ 伝票番号                   │ 得意先コード                      │
│ 商品コード                 │ 数量                              │
│ 単位ID (FK)                │ 2次情報入力日                     │
│ 発生経緯                   │ 発生原因                          │
│ 写真データURI              │ 3次情報入力日                     │
│ 再発防止策                 │ ステータス                        │
│ 1次情報入力日              │ 2次情報入力日                     │
│ 3次情報入力日              │ 作成日時                          │
│ 更新日時                   │ 作成者 (FK)                       │
│ 更新者 (FK)                │                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐
│インシデント │    │ システムログ │
│監査ログ     │    │             │
│             │    │ ID (PK)     │
│ ID (PK)     │    │ ログレベル  │
│ インシデントID│    │ メッセージ  │
│ アクション  │    │ 例外        │
│ フィールド名│    │ ユーザーID(FK)│
│ 変更前値    │    │ リクエストID│
│ 変更後値    │    │ 作成日時    │
│ 変更者      │    └─────────────┘
│ 変更日時    │
└─────────────┘
```

---

## 5. テーブル詳細仕様

### 5.1 マスタテーブル群

#### 5.1.1 部門（部門マスタ）
```sql
CREATE TABLE 部門 (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    名称 NVARCHAR(50) NOT NULL,
    有効フラグ BIT NOT NULL DEFAULT 1,
    作成日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    更新日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);
```

**説明**: 所属部門を管理するマスタテーブル
**主な用途**: インシデントの部門分類、ユーザーの所属管理

#### 5.1.2 発生場所（発生場所マスタ）
```sql
CREATE TABLE 発生場所 (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    名称 NVARCHAR(50) NOT NULL,
    有効フラグ BIT NOT NULL DEFAULT 1,
    作成日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    更新日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);
```

**説明**: トラブル発生場所を管理するマスタテーブル
**主な用途**: インシデントの発生場所分類

#### 5.1.3 倉庫（倉庫マスタ）
```sql
CREATE TABLE 倉庫 (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    名称 NVARCHAR(50) NOT NULL,
    有効フラグ BIT NOT NULL DEFAULT 1,
    作成日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    更新日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);
```

**説明**: 倉庫を管理するマスタテーブル
**主な用途**: インシデントの出荷元倉庫分類

#### 5.1.4 運送会社（運送会社マスタ）
```sql
CREATE TABLE 運送会社 (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    名称 NVARCHAR(50) NOT NULL,
    有効フラグ BIT NOT NULL DEFAULT 1,
    作成日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    更新日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);
```

**説明**: 運送会社を管理するマスタテーブル
**主な用途**: インシデントの運送会社分類

#### 5.1.5 トラブル区分（トラブル区分マスタ）
```sql
CREATE TABLE トラブル区分 (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    名称 NVARCHAR(50) NOT NULL,
    有効フラグ BIT NOT NULL DEFAULT 1,
    作成日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    更新日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);
```

**説明**: トラブル区分を管理するマスタテーブル
**主な用途**: インシデントのトラブル区分分類

#### 5.1.6 トラブル詳細区分（トラブル詳細区分マスタ）
```sql
CREATE TABLE トラブル詳細区分 (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    名称 NVARCHAR(50) NOT NULL,
    トラブル区分ID INT NOT NULL,
    有効フラグ BIT NOT NULL DEFAULT 1,
    作成日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    更新日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);
```

**説明**: トラブル詳細区分を管理するマスタテーブル
**主な用途**: インシデントのトラブル詳細区分分類
**リレーション**: トラブル区分 と 1対多

#### 5.1.7 単位（単位マスタ）
```sql
CREATE TABLE 単位 (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    コード NVARCHAR(10) NOT NULL UNIQUE,
    名称 NVARCHAR(20) NOT NULL,
    有効フラグ BIT NOT NULL DEFAULT 1,
    作成日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    更新日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);
```

**説明**: 数量の単位を管理するマスタテーブル
**主な用途**: インシデントの数量単位管理

### 5.2 ユーザー管理テーブル

#### 5.2.1 ユーザー（ユーザーマスタ）
```sql
CREATE TABLE ユーザー (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    ユーザーID NVARCHAR(50) NOT NULL UNIQUE,
    氏名 NVARCHAR(100) NOT NULL,
    メール NVARCHAR(255),
    部門ID INT,
    アクセスレベル NVARCHAR(20) NOT NULL DEFAULT '一般', -- 'システム管理者', '部門管理者', '倉庫管理者', '一般'
    デフォルト倉庫ID INT, -- デフォルトで表示する倉庫
    有効フラグ BIT NOT NULL DEFAULT 1,
    作成日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    更新日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    FOREIGN KEY (部門ID) REFERENCES 部門(ID),
    FOREIGN KEY (デフォルト倉庫ID) REFERENCES 倉庫(ID)
);
```

**説明**: システムユーザーを管理するテーブル
**主な用途**: 認証・認可、インシデントの作成者管理、倉庫管理者の倉庫指定
**リレーション**: 部門, 倉庫 と 多対1
**特徴**: 
- アクセスレベルによる基本的な権限制御
- デフォルト倉庫IDによる倉庫管理者の倉庫指定

#### 5.2.2 ユーザーロール（ユーザーロール）
```sql
CREATE TABLE ユーザーロール (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    ユーザーID INT NOT NULL,
    ロール NVARCHAR(50) NOT NULL,
    作成日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    FOREIGN KEY (ユーザーID) REFERENCES ユーザー(ID),
    UNIQUE(ユーザーID, ロール)
);
```

**説明**: ユーザーのロールを管理するテーブル
**主な用途**: ロールベースアクセス制御（RBAC）
**リレーション**: ユーザー と 多対1

### 5.3 メインデータテーブル

#### 5.3.1 インシデント（インシデント）
```sql
CREATE TABLE インシデント (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    
    -- 1次情報
    作成日 DATE NOT NULL,
    部門ID INT NOT NULL,
    作成者ID INT NOT NULL,
    発生日時 DATETIME2 NOT NULL,
    発生場所ID INT NOT NULL,
    倉庫ID INT NOT NULL,
    運送会社ID INT NOT NULL,
    トラブル区分ID INT NOT NULL,
    トラブル詳細区分ID INT NOT NULL,
    内容詳細 NVARCHAR(MAX) NOT NULL,
    伝票番号 NVARCHAR(50),
    得意先コード NVARCHAR(50),
    商品コード NVARCHAR(50),
    数量 DECIMAL(18,2),
    単位ID INT,
    
    -- 2次情報
    "2次情報入力日" DATE,
    発生経緯 NVARCHAR(MAX),
    発生原因 NVARCHAR(MAX),
    写真データURI NVARCHAR(MAX),
    
    -- 3次情報
    "3次情報入力日" DATE,
    再発防止策 NVARCHAR(MAX),
    
    -- ステータス管理
    ステータス NVARCHAR(20) NOT NULL,
    
    -- システム情報
    作成日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    更新日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    作成者 INT NOT NULL,
    更新者 INT NOT NULL
);
```

**説明**: インシデント情報のメインテーブル
**主な用途**: 3段階情報管理システムの実装
**特徴**: 
- 1次情報、2次情報、3次情報を1テーブルで管理
- ステータス管理による進捗追跡
- シンプルな構造で運用性を重視

### 5.4 監査・ログテーブル

#### 5.4.1 インシデント監査ログ（インシデント監査ログ）
```sql
CREATE TABLE インシデント監査ログ (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    インシデントID INT NOT NULL,
    アクション NVARCHAR(50) NOT NULL, -- 作成, 更新, 削除
    フィールド名 NVARCHAR(100),
    変更前値 NVARCHAR(MAX),
    変更後値 NVARCHAR(MAX),
    変更者 INT NOT NULL,
    変更日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    FOREIGN KEY (インシデントID) REFERENCES インシデント(ID),
    FOREIGN KEY (変更者) REFERENCES ユーザー(ID)
);
```

**説明**: インシデントの変更履歴を記録するテーブル
**主な用途**: 監査証跡、変更履歴の追跡
**リレーション**: インシデント, ユーザー と 多対1

#### 5.4.2 システムログ（システムログ）
```sql
CREATE TABLE システムログ (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    ログレベル NVARCHAR(20) NOT NULL, -- 情報, 警告, エラー
    メッセージ NVARCHAR(MAX) NOT NULL,
    例外 NVARCHAR(MAX),
    ユーザーID INT,
    リクエストID UNIQUEIDENTIFIER,
    作成日時 DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    FOREIGN KEY (ユーザーID) REFERENCES ユーザー(ID)
);
```

**説明**: システムログを記録するテーブル
**主な用途**: システム監視、エラー追跡
**リレーション**: ユーザー と 多対1

---

## 6. リレーションシップ

### 6.1 主要なリレーションシップ

#### 6.1.1 インシデント（メインテーブル）の外部キー関係
| 外部キー | 参照先テーブル | 関係 | 説明 |
|----------|----------------|------|------|
| 部門ID | 部門 | 多対1 | 所属部門 |
| 作成者ID | ユーザー | 多対1 | 作成者 |
| 発生場所ID | 発生場所 | 多対1 | 発生場所 |
| 倉庫ID | 倉庫 | 多対1 | 倉庫 |
| 運送会社ID | 運送会社 | 多対1 | 運送会社 |
| トラブル区分ID | トラブル区分 | 多対1 | トラブル区分 |
| トラブル詳細区分ID | トラブル詳細区分 | 多対1 | トラブル詳細区分 |
| 単位ID | 単位 | 多対1 | 単位 |
| 作成者 | ユーザー | 多対1 | 作成者（システム） |
| 更新者 | ユーザー | 多対1 | 更新者（システム） |

#### 6.1.2 マスタテーブル間の関係
| テーブル | 外部キー | 参照先テーブル | 関係 | 説明 |
|----------|----------|----------------|------|------|
| トラブル詳細区分 | トラブル区分ID | トラブル区分 | 多対1 | トラブル詳細区分の親分類 |
| ユーザー | 部門ID | 部門 | 多対1 | ユーザーの所属部門 |
| ユーザー | デフォルト倉庫ID | 倉庫 | 多対1 | ユーザーのデフォルト倉庫 |

#### 6.1.3 監査・ログテーブルの関係
| テーブル | 外部キー | 参照先テーブル | 関係 | 説明 |
|----------|----------|----------------|------|------|
| インシデント監査ログ | インシデントID | インシデント | 多対1 | 監査対象のインシデント |
| インシデント監査ログ | 変更者 | ユーザー | 多対1 | 変更者 |
| システムログ | ユーザーID | ユーザー | 多対1 | ログ発生時のユーザー |

### 6.2 リレーションシップ図

```
部門 (1) ──── (多) ユーザー
部門 (1) ──── (多) インシデント

ユーザー (1) ──── (多) ユーザーロール
ユーザー (1) ──── (多) インシデント (作成者ID)
ユーザー (1) ──── (多) インシデント (作成者)
ユーザー (1) ──── (多) インシデント (更新者)
ユーザー (1) ──── (多) インシデント監査ログ
ユーザー (1) ──── (多) システムログ
倉庫 (1) ──── (多) ユーザー (デフォルト倉庫)

トラブル区分 (1) ──── (多) トラブル詳細区分
トラブル区分 (1) ──── (多) インシデント
トラブル詳細区分 (1) ──── (多) インシデント

発生場所 (1) ──── (多) インシデント
倉庫 (1) ──── (多) インシデント
運送会社 (1) ──── (多) インシデント
単位 (1) ──── (多) インシデント

インシデント (1) ──── (多) インシデント監査ログ
```

---

## 7. インデックス設計

### 7.1 パフォーマンス向上のためのインデックス

#### 7.1.1 単一カラムインデックス
```sql
-- インシデント テーブル
CREATE INDEX IX_インシデント_作成日 ON インシデント(作成日);
CREATE INDEX IX_インシデント_ステータス ON インシデント(ステータス);
CREATE INDEX IX_インシデント_部門ID ON インシデント(部門ID);
CREATE INDEX IX_インシデント_発生日時 ON インシデント(発生日時);
CREATE INDEX IX_インシデント_倉庫ID ON インシデント(倉庫ID);
CREATE INDEX IX_インシデント_トラブル区分ID ON インシデント(トラブル区分ID);
CREATE INDEX IX_インシデント_作成者ID ON インシデント(作成者ID);

-- 監査ログテーブル
CREATE INDEX IX_インシデント監査ログ_インシデントID ON インシデント監査ログ(インシデントID);
CREATE INDEX IX_インシデント監査ログ_変更日時 ON インシデント監査ログ(変更日時);
CREATE INDEX IX_インシデント監査ログ_変更者 ON インシデント監査ログ(変更者);

-- システムログテーブル
CREATE INDEX IX_システムログ_作成日時 ON システムログ(作成日時);
CREATE INDEX IX_システムログ_ログレベル ON システムログ(ログレベル);
CREATE INDEX IX_システムログ_ユーザーID ON システムログ(ユーザーID);

```

#### 7.1.2 複合インデックス
```sql
-- 検索条件の組み合わせに対応
CREATE INDEX IX_インシデント_ステータス_作成日 ON インシデント(ステータス, 作成日);
CREATE INDEX IX_インシデント_部門_ステータス ON インシデント(部門ID, ステータス);
CREATE INDEX IX_インシデント_倉庫_ステータス ON インシデント(倉庫ID, ステータス);
CREATE INDEX IX_インシデント_区分_ステータス ON インシデント(トラブル区分ID, ステータス);
CREATE INDEX IX_インシデント_作成者_ステータス ON インシデント(作成者ID, ステータス);

-- 日付範囲検索用
CREATE INDEX IX_インシデント_発生日時_ステータス ON インシデント(発生日時, ステータス);
```

#### 7.1.3 カバリングインデックス
```sql
-- 頻繁にアクセスされるカラムの組み合わせ
CREATE INDEX IX_インシデント_ステータス_カバリング ON インシデント(ステータス) 
INCLUDE (ID, インシデント番号, 作成日, 部門ID, 作成者ID);
```

### 7.2 インデックス設計の考慮事項

#### 7.2.1 検索パターンの分析
- **ダッシュボード表示**: ステータス別、部門別、倉庫別の集計
- **インシデント一覧**: 日付範囲、ステータス、部門での絞り込み
- **レポート出力**: 期間指定、複数条件での検索

#### 7.2.2 パフォーマンス要件
- **画面表示**: 3秒以内
- **検索処理**: 5秒以内
- **CSV出力**: 10秒以内

---

## 8. 初期データ

### 8.1 マスタデータの投入

#### 8.1.1 部門マスタ
```sql
INSERT INTO 部門 (コード, 名称) VALUES
('HQ_A', '本社A'),
('HQ_B', '本社B'),
('EAST', '東日本'),
('WEST', '西日本');
```

#### 8.1.2 発生場所マスタ
```sql
INSERT INTO 発生場所 (コード, 名称) VALUES
('WAREHOUSE_IN', '倉庫（入荷作業）'),
('WAREHOUSE_STORE', '倉庫（格納作業）'),
('WAREHOUSE_OUT', '倉庫（出荷作業）'),
('DELIVERY_PICKUP', '配送（集荷/配達）'),
('DELIVERY_FACILITY', '配送（施設内）'),
('CUSTOMER', 'お客様先');
```

#### 8.1.3 倉庫マスタ
```sql
INSERT INTO 倉庫 (コード, 名称) VALUES
('SAPPORO', '札幌倉庫'),
('TOKYO', '東京倉庫'),
('SAITAMA', '埼玉倉庫'),
('YOKOHAMA', '横浜倉庫'),
('OSAKA', '大阪倉庫'),
('KOBE', '神戸倉庫'),
('MATSUYAMA', '松山倉庫');
```

#### 8.1.4 運送会社マスタ
```sql
INSERT INTO 運送会社 (コード, 名称) VALUES
('YAMATO', 'ヤマト運輸'),
('SAGAWA', '佐川急便'),
('FUKUYAMA', '福山通運'),
('SEINO', '西濃運輸'),
('CHARTER', 'チャーター'),
('OTHER', 'その他輸送会社');
```

#### 8.1.5 トラブル区分マスタ
```sql
INSERT INTO トラブル区分 (コード, 名称) VALUES
('HANDLING', '荷役トラブル'),
('DELIVERY', '配送トラブル');
```

#### 8.1.6 トラブル詳細区分マスタ
```sql
INSERT INTO トラブル詳細区分 (コード, 名称, トラブル区分ID) VALUES
('WRONG_ITEM', '商品間違い', 1),
('QUANTITY_ERROR', '数量過不足', 1),
('WRONG_DESTINATION', '送付先間違い', 2),
('MISSING_SHIPMENT', '発送漏れ', 2),
('DAMAGE', '破損・汚損', 1),
('LOSS', '紛失', 2),
('OTHER', 'その他の商品事故', 1);
```

#### 8.1.7 単位マスタ
```sql
INSERT INTO 単位 (コード, 名称) VALUES
('PALLET', 'パレット'),
('CASE', 'ケース'),
('BALL', 'ボール'),
('PIECE', 'ピース');
```

### 8.2 初期ユーザーデータ

#### 8.2.1 システム管理者ユーザー
```sql
INSERT INTO ユーザー (ユーザーID, 氏名, メール, 部門ID, アクセスレベル, デフォルト倉庫ID) VALUES
('admin', 'システム管理者', 'admin@company.com', 1, 'システム管理者', NULL);

INSERT INTO ユーザーロール (ユーザーID, ロール) VALUES
(1, 'Administrator'),
(1, 'Manager'),
(1, 'User');

-- 倉庫管理者のサンプルユーザー
INSERT INTO ユーザー (ユーザーID, 氏名, メール, 部門ID, アクセスレベル, デフォルト倉庫ID) VALUES
('warehouse_manager_01', '倉庫管理者01', 'warehouse01@company.com', 1, '倉庫管理者', 1);
```

---

## 9. 運用考慮事項

### 9.1 パフォーマンス最適化

#### 9.1.1 データベース設定
- **メモリ設定**: SQL Server の最大メモリ設定を適切に調整
- **接続プール**: 適切な接続プールサイズの設定
- **クエリプラン**: 定期的なクエリプランの監視

#### 9.1.2 データアーカイブ
- **古いログデータ**: 1年以上前のシステムログのアーカイブ
- **完了インシデント**: 3年以上前の完了インシデントのアーカイブ
- **監査ログ**: 5年以上前の監査ログのアーカイブ

### 9.2 バックアップ戦略

#### 9.2.1 バックアップ頻度
- **フルバックアップ**: 日次（深夜）
- **差分バックアップ**: 4時間ごと
- **トランザクションログバックアップ**: 15分ごと

#### 9.2.2 バックアップ保持期間
- **フルバックアップ**: 30日間
- **差分バックアップ**: 7日間
- **トランザクションログ**: 24時間

### 9.3 セキュリティ考慮事項

#### 9.3.1 データ暗号化
- **保存時暗号化**: TDE（Transparent Data Encryption）の適用
- **転送時暗号化**: TLS 1.3 の使用
- **機密データ**: 個人情報のマスキング

#### 9.3.2 アクセス制御
- **最小権限の原則**: 必要最小限の権限のみ付与
- **ロールベースアクセス**: RBAC の実装
- **監査ログ**: 全アクセスの記録

### 9.4 監視・メンテナンス

#### 9.4.1 パフォーマンス監視
- **クエリ実行時間**: 5秒以上のクエリの監視
- **デッドロック**: デッドロック発生の監視
- **インデックス使用率**: 未使用インデックスの特定

#### 9.4.2 定期メンテナンス
- **統計情報更新**: 週次
- **インデックス再構築**: 月次
- **データベース整合性チェック**: 週次

### 9.5 将来の拡張性

#### 9.5.1 スケーラビリティ
- **水平スケーリング**: 読み取り専用レプリカの追加
- **垂直スケーリング**: サーバーリソースの増強
- **パーティショニング**: 日付ベースのパーティショニング

#### 9.5.2 機能拡張
- **新規マスタテーブル**: 柔軟な設計により容易に追加可能
- **新規ステータス**: ステータス管理の拡張
- **新規ロール**: ユーザーロールの動的追加
- **倉庫別アクセス制御**: ユーザーテーブルのデフォルト倉庫IDによる簡易倉庫管理

### 9.6 倉庫管理者アクセス制御

#### 9.6.1 アクセス制御の階層
```
システム管理者 (全アクセス)
├── 部門管理者 (部門内全アクセス)
│   ├── 倉庫管理者 (デフォルト倉庫のインシデントのみ)
│   └── 一般ユーザー (作成インシデントのみ)
```

#### 9.6.2 アクセス制御の実装方法
1. **ユーザーテーブルのアクセスレベル**: 基本的な権限レベルを設定
2. **デフォルト倉庫ID**: 倉庫管理者の担当倉庫を指定
3. **簡素化された権限管理**: 複雑な権限テーブルを使用せず、ユーザーテーブル内で管理

#### 9.6.3 インシデント表示の制御ロジック
```sql
-- 倉庫管理者のインシデント表示クエリ例
SELECT i.* 
FROM インシデント i
INNER JOIN ユーザー u ON u.ID = @ユーザーID
WHERE 
    -- システム管理者は全アクセス
    (u.アクセスレベル = 'システム管理者')
    OR
    -- 部門管理者は自部門の全インシデント
    (u.アクセスレベル = '部門管理者' AND u.部門ID = i.部門ID)
    OR
    -- 倉庫管理者はデフォルト倉庫のインシデントのみ
    (u.アクセスレベル = '倉庫管理者' AND u.デフォルト倉庫ID = i.倉庫ID)
    OR
    -- 一般ユーザーは作成したインシデントのみ
    (u.アクセスレベル = '一般' AND i.作成者ID = u.ID);
```

#### 9.6.4 簡素化された権限管理の特徴
- **シンプルな構造**: 複雑な権限テーブルを使用せず、ユーザーテーブル内で管理
- **1倉庫1管理者**: 1人の倉庫管理者は1つの倉庫のみを管理
- **容易な管理**: 権限設定がシンプルで管理が容易
- **将来の拡張性**: 必要に応じて複数倉庫管理機能を追加可能

---

## 付録

### A. 用語集

| 用語 | 説明 |
|------|------|
| 正規化 | データベース設計において、データの冗長性を排除し、整合性を保つための手法 |
| 外部キー | 他のテーブルの主キーを参照するカラム |
| インデックス | データベースの検索性能を向上させるためのデータ構造 |
| 監査ログ | データの変更履歴を記録するログ |
| RBAC | Role-Based Access Control（ロールベースアクセス制御） |

### B. 参考資料

- [SQL Server 2022 公式ドキュメント](https://docs.microsoft.com/ja-jp/sql/sql-server/)
- [Entity Framework Core 8.0 公式ドキュメント](https://docs.microsoft.com/ja-jp/ef/core/)
- [データベース設計のベストプラクティス](https://docs.microsoft.com/ja-jp/azure/architecture/best-practices/data-partitioning)

---

**文書の終わり**
